{% extends "base.html" %}

{% block title %}Analyze Properties{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
#property-map {
    height: calc(100vh - 450px);
    min-height: 400px;
    border-radius: 8px;
    margin-top: 1rem;
}
.marker-property {
    background: #2563eb;
    border: 2px solid white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
}
.marker-comp {
    background: #16a34a;
    border: 2px solid white;
    border-radius: 50%;
    width: 12px;
    height: 12px;
}
.marker-comp-selected {
    background: #eab308;
    border: 2px solid white;
    border-radius: 50%;
    width: 14px;
    height: 14px;
}
.comp-card {
    cursor: pointer;
    transition: all 0.2s;
}
.comp-card:hover {
    transform: translateX(4px);
}
.comp-card.comp-highlighted {
    border: 2px solid #2563eb;
    background: #eff6ff;
}
.comp-select {
    position: absolute;
    top: 8px;
    left: 8px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    z-index: 10;
}
.comp-card {
    position: relative;
}
.comp-card img {
    margin-left: 20px;
    width: 50px;
}
#market-calc {
    background: #f0fdf4;
    border: 1px solid #16a34a;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    font-size: 0.75rem;
}
#market-calc .calc-title {
    font-weight: 600;
    color: #16a34a;
    margin-bottom: 0.5rem;
}
#market-calc .calc-row {
    display: flex;
    justify-content: space-between;
    margin: 0.25rem 0;
}
#market-calc .calc-value {
    font-weight: 600;
}
.comps-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    font-weight: 600;
    font-size: 0.8rem;
    border-bottom: 1px solid #e5e7eb;
    margin-bottom: 0.5rem;
}
.btn-expand {
    font-size: 0.65rem;
    padding: 0.25rem 0.5rem;
}
.comps-total {
    font-size: 0.65rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
}
.comps-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.btn-refresh {
    background: none;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    padding: 0.2rem 0.4rem;
    font-size: 0.75rem;
    cursor: pointer;
    color: #6b7280;
}
.btn-refresh:hover {
    background: #f3f4f6;
    color: #374151;
}
/* School district styles */
.school-info {
    background: #fefce8;
    border: 1px solid #fbbf24;
}
.school-info h4 {
    color: #92400e;
}
.district-name {
    font-weight: 600;
    font-size: 0.85rem;
    color: #78350f;
    margin-bottom: 0.5rem;
}
.schools-list {
    font-size: 0.7rem;
    color: #6b7280;
}
.school-item {
    display: flex;
    justify-content: space-between;
    margin: 0.25rem 0;
}
.school-rating {
    color: #16a34a;
    font-weight: 600;
}
/* Comp school badge */
.comp-school-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 0.6rem;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
    z-index: 10;
}
.comp-school-badge.same-district {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #16a34a;
}
.comp-school-badge.diff-district {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #f59e0b;
}
/* Profit analysis styles - accounting aesthetic */
.profit-section {
    background: #fff;
    border: 1px solid #e5e7eb;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
}
.profit-placeholder {
    color: #9ca3af;
    font-style: italic;
    text-align: center;
    padding: 0.75rem;
    font-size: 0.65rem;
}
.profit-breakdown {
    font-size: 0.55rem;
    line-height: 1.3;
}
.profit-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.1rem 0;
    border-bottom: 1px dotted #f3f4f6;
    min-height: 1.2rem;
}
.profit-row:last-child {
    border-bottom: none;
}
.profit-row.total {
    font-weight: 600;
    font-size: 0.55rem;
    background: #f9fafb;
    margin: 0.15rem -0.5rem;
    padding: 0.2rem 0.5rem;
    border-bottom: none;
}
.profit-row.subtotal {
    font-weight: 500;
    border-top: 1px solid #e5e7eb;
    margin-top: 0.1rem;
    padding-top: 0.15rem;
}
.profit-row.input-row {
    background: #fffbeb;
    margin: 0.15rem -0.5rem;
    padding: 0.15rem 0.5rem;
    border: 1px solid #fbbf24;
    border-radius: 3px;
}
.profit-row.result-row {
    background: #ecfdf5;
    margin: 0.15rem -0.5rem;
    padding: 0.2rem 0.5rem;
    border: 1px solid #10b981;
    border-radius: 3px;
    font-weight: 600;
}
.profit-label {
    color: #6b7280;
}
.profit-value {
    font-weight: 500;
    text-align: right;
    font-variant-numeric: tabular-nums;
}
.profit-value.negative {
    color: #dc2626;
}
.profit-value.positive {
    color: #16a34a;
}
.profit-value.highlight {
    color: #2563eb;
    font-weight: 600;
}
.profit-value.profit-high {
    color: #16a34a;
    font-weight: 700;
}
.profit-value.profit-medium {
    color: #ca8a04;
    font-weight: 700;
}
.profit-value.profit-low {
    color: #dc2626;
    font-weight: 700;
}
.profit-divider {
    border-top: 1px solid #d1d5db;
    margin: 0.2rem 0;
}
.profit-section-header {
    font-size: 0.45rem;
    text-transform: uppercase;
    color: #9ca3af;
    letter-spacing: 0.05em;
    margin: 0.25rem 0 0.1rem;
}
.build-cost-input {
    width: 60px;
    padding: 0.2rem 0.3rem;
    border: 1px solid #d1d5db;
    border-radius: 3px;
    font-size: 0.55rem;
    font-family: inherit;
    text-align: right;
    height: 1.1rem;
    box-sizing: border-box;
}
/* Loading spinner */
.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
    color: #6b7280;
}
.spinner {
    font-size: 32px;
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 0.75rem;
}
.spinner::before {
    content: 'üè†';
}
@keyframes spin {
    0% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(90deg) scale(1.1); }
    50% { transform: rotate(180deg) scale(1); }
    75% { transform: rotate(270deg) scale(1.1); }
    100% { transform: rotate(360deg) scale(1); }
}
.loading-text {
    font-size: 0.8rem;
    text-align: center;
}
.loading-subtext {
    font-size: 0.7rem;
    color: #9ca3af;
    margin-top: 0.25rem;
}
</style>
{% endblock %}

{% block content %}
<div class="search-header">
    <h1>Property Analysis</h1>
    <p>Select a property to view analysis and comparable sales</p>
</div>

<div id="no-selection" class="no-selection">
    <h2>No Properties Selected</h2>
    <p>Go to <a href="/">Search</a> and select properties to analyze.</p>
</div>

<div id="analyze-layout" class="analyze-layout" style="display: none;">
    <!-- Left: Analysis Details -->
    <div class="analyze-main" id="analyze-main">
        <div id="analysis-detail">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <div class="loading-text">Loading analysis...</div>
            </div>
        </div>
    </div>
    <div class="resize-handle" id="resize-right"></div>

    <!-- Right: Market Comps -->
    <div class="analyze-right" id="analyze-right">
        <h3>Sales in Area</h3>
        <div id="comps-list">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <div class="loading-text">Loading comps...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let analysisData = {};
let activePropertyId = null;
let map = null;
let compMarkers = [];
let currentRadius = 1;
let currentProperty = null;
let compsCache = {};  // Cache comps by property_id + radius
let propertySchoolDistrict = null;  // Store property's school district for comparison
let schoolCache = {};  // Cache school info by zpid
let realisticBuildCost = 400;  // Default $400/sqft
let lastCompData = null;  // Store last comp data for recalc on input change

async function loadAnalyzePage() {
    const selected = await getSelected();

    if (selected.length === 0) {
        document.getElementById('no-selection').style.display = 'block';
        document.getElementById('analyze-layout').style.display = 'none';
        return;
    }

    document.getElementById('no-selection').style.display = 'none';
    document.getElementById('analyze-layout').style.display = 'flex';

    // Load first selected property
    const property = selected[0];
    activePropertyId = property.id;
    loadAnalysis(property);
    loadComps(property);
}

async function loadAnalysis(property) {
    const container = document.getElementById('analysis-detail');
    container.innerHTML = `
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text">Analyzing property...</div>
        </div>
    `;

    try {
        // Fetch analysis and school info in parallel
        const [analysisResponse, schoolData] = await Promise.all([
            fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ property: property })
            }),
            fetchSchoolInfo(property.zpid || property.id)
        ]);

        const analysis = await analysisResponse.json();
        analysis.schoolInfo = schoolData;
        propertySchoolDistrict = schoolData?.school_district?.district_name || null;

        renderAnalysis(analysis);
    } catch (error) {
        container.innerHTML = '<div class="error">Error analyzing property</div>';
        console.error(error);
    }
}

async function fetchSchoolInfo(zpid) {
    if (!zpid) return null;

    // Check cache first
    if (schoolCache[zpid]) {
        return schoolCache[zpid];
    }

    try {
        const response = await fetch(`/api/property/details?zpid=${zpid}`);
        const data = await response.json();
        if (data.success) {
            schoolCache[zpid] = data;
            return data;
        }
    } catch (error) {
        console.error('Error fetching school info:', error);
    }
    return null;
}

function renderAnalysis(analysis) {
    const container = document.getElementById('analysis-detail');
    const prop = analysis.property;
    const addr = prop.address || {};

    const lotSize = prop.lotAreaUnit === 'acres'
        ? `${prop.lotAreaValue?.toFixed(2)} acres`
        : `${Math.round(prop.lotAreaValue || 0).toLocaleString()} sqft`;

    container.innerHTML = `
        <div class="analysis-detail-card">
            <div class="analysis-detail-header">
                <img src="${prop.imgSrc}" alt="${addr.street}">
                <div class="analysis-detail-title">
                    <h2>${addr.street}</h2>
                    <p>${addr.city}, ${addr.state} ${addr.zipcode}</p>
                    <a href="${prop.detailUrl}" target="_blank" class="btn btn-link">View on Zillow ‚Üí</a>
                </div>
            </div>

            <div class="analysis-sections">
                <div class="analysis-section-card">
                    <h4>Current Property</h4>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span class="stat-label">Asking Price</span>
                            <span class="stat-value">$${analysis.asking_price?.toLocaleString()}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Lot Size</span>
                            <span class="stat-value">${lotSize}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Beds / Baths</span>
                            <span class="stat-value">${prop.beds} bd / ${prop.baths} ba</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Current Size</span>
                            <span class="stat-value">${(prop.livingArea || 0).toLocaleString()} sqft</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Days on Market</span>
                            <span class="stat-value">${prop.daysOnZillow || 0}</span>
                        </div>
                    </div>
                </div>

                <div class="analysis-section-card school-info">
                    <h4>School District</h4>
                    <div id="school-district-info">
                        ${renderSchoolInfo(analysis.schoolInfo)}
                    </div>
                </div>

                <div class="analysis-section-card profit-section">
                    <h4>Profit Analysis</h4>
                    <div id="profit-analysis">
                        <div class="profit-placeholder">
                            Select comps on the right to calculate profit analysis
                        </div>
                    </div>
                </div>

                <div id="property-map"></div>
            </div>
        </div>
    `;

    // Initialize map with property location
    if (prop.latLong?.latitude) {
        initMap(prop);
    }
}

function renderSchoolInfo(schoolInfo) {
    if (!schoolInfo || !schoolInfo.school_district) {
        return '<div class="stat-value">Loading...</div>';
    }

    const district = schoolInfo.school_district;
    const schools = schoolInfo.schools || [];

    let schoolsHtml = '';
    if (schools.length > 0) {
        schoolsHtml = schools.slice(0, 3).map(s => {
            const rating = s.rating ? `<span class="school-rating">${s.rating}/10</span>` : '';
            return `<div class="school-item"><span class="school-name">${s.name}</span> ${rating}</div>`;
        }).join('');
    }

    return `
        <div class="district-name">${district.district_name || 'Unknown'}</div>
        <div class="schools-list">${schoolsHtml}</div>
    `;
}

async function loadComps(property, radius = 1, forceRefresh = false) {
    const container = document.getElementById('comps-list');
    const city = property.address?.city || '';
    const cacheKey = `${property.id}_${radius}`;

    // Store for radius expansion
    currentProperty = property;
    currentRadius = radius;

    if (!property.latLong || !property.latLong.latitude) {
        container.innerHTML = '<div class="no-comps">Location data not available</div>';
        return;
    }

    // Check cache first (unless force refresh)
    if (!forceRefresh && compsCache[cacheKey]) {
        console.log('Using cached comps for', cacheKey);
        const data = compsCache[cacheKey];
        if (data.results && data.results.length > 0) {
            renderComps(data.results, city, data.total_in_city, data.more_in_next_mile, radius);
        } else {
            const expandBtn = data.more_in_next_mile > 0
                ? `<button class="btn btn-secondary" onclick="expandRadius()">Expand to ${radius + 1} miles (+${data.more_in_next_mile} more)</button>`
                : '';
            container.innerHTML = `<div class="no-comps">No sales within ${radius} mile${radius > 1 ? 's' : ''} in ${city}<br>${expandBtn}</div>`;
        }
        return;
    }

    container.innerHTML = `
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text">Loading sales in ${city}</div>
            <div class="loading-subtext">Within ${radius} mile${radius > 1 ? 's' : ''} ¬∑ Fetching all pages...</div>
        </div>
    `;

    try {
        const lat = property.latLong.latitude;
        const lng = property.latLong.longitude;
        const response = await fetch(`/api/comps/nearby?lat=${lat}&lng=${lng}&city=${encodeURIComponent(city)}&radius=${radius}`);
        const data = await response.json();

        // Cache the results
        compsCache[cacheKey] = data;
        console.log('Cached comps for', cacheKey);

        if (data.success && data.results.length > 0) {
            renderComps(data.results, city, data.total_in_city, data.more_in_next_mile, radius);
        } else {
            const expandBtn = data.more_in_next_mile > 0
                ? `<button class="btn btn-secondary" onclick="expandRadius()">Expand to ${radius + 1} miles (+${data.more_in_next_mile} more)</button>`
                : '';
            container.innerHTML = `<div class="no-comps">No sales within ${radius} mile${radius > 1 ? 's' : ''} in ${city}<br>${expandBtn}</div>`;
        }
    } catch (error) {
        container.innerHTML = '<div class="error">Error loading comps</div>';
        console.error(error);
    }
}

function expandRadius() {
    if (currentProperty) {
        loadComps(currentProperty, currentRadius + 1);
    }
}

function refreshComps() {
    if (currentProperty) {
        // Clear cache for this property at all radii
        Object.keys(compsCache).forEach(key => {
            if (key.startsWith(currentProperty.id + '_')) {
                delete compsCache[key];
            }
        });
        loadComps(currentProperty, currentRadius, true);
    }
}

function clearCompsCache() {
    compsCache = {};
    console.log('Comps cache cleared');
}

function renderComps(comps, city, totalInCity, moreInNextMile, radius) {
    const container = document.getElementById('comps-list');
    const expandBtn = moreInNextMile > 0
        ? `<button class="btn btn-secondary btn-expand" onclick="expandRadius()">+${moreInNextMile} more in ${radius + 1}mi</button>`
        : '';
    const header = `
        <div class="comps-header">
            <span>${comps.length} sales within ${radius} mi</span>
            <div class="comps-actions">
                ${expandBtn}
                <button class="btn-refresh" onclick="refreshComps()" title="Refresh comps">‚Üª</button>
            </div>
        </div>
        <div class="comps-total">${totalInCity} total in ${city}</div>
        <div id="market-calc" style="display: none;">
            <div class="calc-title">Market Calculation</div>
            <div class="calc-row"><span>Selected:</span> <span class="calc-value" id="calc-count">0</span></div>
            <div class="calc-row"><span>Avg $/sqft:</span> <span class="calc-value" id="calc-ppsf">$0</span></div>
            <div class="calc-row"><span>Avg Price:</span> <span class="calc-value" id="calc-price">$0</span></div>
            <div class="calc-row"><span>Avg Size:</span> <span class="calc-value" id="calc-size">0 sf</span></div>
        </div>
    `;
    const compsHtml = comps.map(comp => {
        const addr = comp.address || {};
        const pricePerSqft = comp.livingArea > 0 ? Math.round(comp.unformattedPrice / comp.livingArea) : 0;
        const lotSize = comp.lotAreaUnit === 'acres'
            ? `${comp.lotAreaValue?.toFixed(2)} ac`
            : `${Math.round(comp.lotAreaValue || 0).toLocaleString()} sf lot`;
        const zpid = comp.zpid || comp.id;

        return `
            <div class="comp-card" data-id="${comp.id}" data-zpid="${zpid}" data-price="${comp.unformattedPrice}" data-sqft="${comp.livingArea || 0}">
                <input type="checkbox" class="comp-select" onclick="event.stopPropagation(); updateMarketCalc()" title="Use for market calculation">
                <div class="comp-school-badge" data-zpid="${zpid}" title="Loading school info..."></div>
                <img src="${comp.imgSrc}" alt="" onclick="showCompOnMap('${comp.id}')">
                <div class="comp-card-info" onclick="showCompOnMap('${comp.id}')">
                    <div class="comp-card-price">$${comp.unformattedPrice?.toLocaleString()}</div>
                    <div class="comp-card-ppsf">$${pricePerSqft}/sqft</div>
                    <div class="comp-card-address">${addr.street || 'N/A'}</div>
                    <div class="comp-card-city">${addr.city}, ${addr.state}</div>
                    <div class="comp-card-details">
                        ${comp.beds || '?'}bd ${comp.baths || '?'}ba ¬∑ ${(comp.livingArea || 0).toLocaleString()}sf
                    </div>
                    <div class="comp-card-lot">${lotSize}</div>
                    <div class="comp-card-distance">${comp.distance} miles away</div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = header + '<div class="comps-scroll">' + compsHtml + '</div>';

    // Add comp markers to map
    addCompMarkers(comps);

    // Load school info for comps (in background)
    loadCompSchoolInfo(comps);
}

async function loadCompSchoolInfo(comps) {
    // Only load school info if we have the property's school district
    if (!propertySchoolDistrict) {
        document.querySelectorAll('.comp-school-badge').forEach(badge => {
            badge.style.display = 'none';
        });
        return;
    }

    // Load school info for each comp (with rate limiting)
    for (const comp of comps) {
        const zpid = comp.zpid || comp.id;
        const badge = document.querySelector(`.comp-school-badge[data-zpid="${zpid}"]`);
        if (!badge) continue;

        try {
            const schoolData = await fetchSchoolInfo(zpid);
            if (schoolData && schoolData.school_district) {
                const compDistrict = schoolData.school_district.district_name || '';
                const isSame = compDistrict.toLowerCase() === propertySchoolDistrict.toLowerCase();

                badge.className = `comp-school-badge ${isSame ? 'same-district' : 'diff-district'}`;
                badge.textContent = isSame ? 'Same' : 'Diff';
                badge.title = compDistrict || 'Unknown district';
            } else {
                badge.style.display = 'none';
            }
        } catch (error) {
            badge.style.display = 'none';
        }

        // Small delay to avoid rate limiting
        await new Promise(resolve => setTimeout(resolve, 100));
    }
}

// Map functions
function initMap(property) {
    const lat = property.latLong.latitude;
    const lng = property.latLong.longitude;

    // Remove existing map if any
    if (map) {
        map.remove();
    }

    map = L.map('property-map').setView([lat, lng], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Add property marker (blue, larger)
    const propertyIcon = L.divIcon({
        className: 'marker-property',
        iconSize: [16, 16],
        iconAnchor: [8, 8]
    });

    L.marker([lat, lng], { icon: propertyIcon })
        .addTo(map)
        .bindPopup(`<strong>${property.address?.street}</strong><br>$${property.unformattedPrice?.toLocaleString()}`);
}

function addCompMarkers(comps) {
    if (!map) return;

    // Clear existing comp markers
    compMarkers.forEach(m => map.removeLayer(m));
    compMarkers = [];

    const compIcon = L.divIcon({
        className: 'marker-comp',
        iconSize: [12, 12],
        iconAnchor: [6, 6]
    });

    const bounds = [];

    comps.forEach((comp, index) => {
        if (comp.latLong?.latitude) {
            const lat = comp.latLong.latitude;
            const lng = comp.latLong.longitude;
            bounds.push([lat, lng]);

            const addr = comp.address || {};
            const pricePerSqft = comp.livingArea > 0 ? Math.round(comp.unformattedPrice / comp.livingArea) : 0;

            const popupContent = `
                <div style="min-width: 180px; font-family: -apple-system, sans-serif;">
                    <img src="${comp.imgSrc}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;">
                    <div style="font-weight: 700; color: #16a34a; font-size: 14px;">$${comp.unformattedPrice?.toLocaleString()}</div>
                    <div style="font-size: 11px; color: #666;">$${pricePerSqft}/sqft</div>
                    <div style="font-size: 12px; margin-top: 4px;">${addr.street || 'N/A'}</div>
                    <div style="font-size: 11px; color: #666;">${comp.beds || '?'}bd ${comp.baths || '?'}ba ¬∑ ${(comp.livingArea || 0).toLocaleString()}sf</div>
                    <div style="font-size: 10px; color: #2563eb; margin-top: 4px;">${comp.distance} miles away</div>
                </div>
            `;

            const marker = L.marker([lat, lng], { icon: compIcon })
                .addTo(map)
                .bindPopup(popupContent);

            // Store comp id on marker for reference
            marker.compId = comp.id;
            marker.compIndex = index;

            // When marker popup opens, highlight comp in list
            marker.on('popupopen', () => {
                highlightCompInList(comp.id);
            });

            compMarkers.push(marker);
        }
    });

    // Fit map to show all markers
    if (bounds.length > 0 && compMarkers.length > 0) {
        const group = L.featureGroup(compMarkers);
        map.fitBounds(group.getBounds().pad(0.2));
    }
}

function highlightCompInList(compId) {
    // Remove highlight from all comps
    document.querySelectorAll('.comp-card').forEach(el => {
        el.classList.remove('comp-highlighted');
    });

    // Highlight and scroll within comps container only
    const compCard = document.querySelector(`.comp-card[data-id="${compId}"]`);
    const compsScroll = document.querySelector('.comps-scroll');
    if (compCard && compsScroll) {
        compCard.classList.add('comp-highlighted');
        // Scroll within the comps container, not the page
        const cardTop = compCard.offsetTop - compsScroll.offsetTop;
        compsScroll.scrollTo({ top: cardTop - 50, behavior: 'smooth' });
    }
}

function showCompOnMap(compId) {
    const marker = compMarkers.find(m => m.compId === compId);
    if (marker) {
        // Prevent page scroll by using map's internal pan
        map.setView(marker.getLatLng(), 15, { animate: true });
        setTimeout(() => marker.openPopup(), 300);
    }
}

function updateMarketCalc() {
    const selected = document.querySelectorAll('.comp-card input.comp-select:checked');
    const calcBox = document.getElementById('market-calc');

    // Update marker colors on map
    updateCompMarkerColors();

    if (selected.length === 0) {
        calcBox.style.display = 'none';
        // Reset profit analysis to default
        updateProfitAnalysis(null);
        return;
    }

    calcBox.style.display = 'block';

    let totalPrice = 0;
    let totalSqft = 0;
    let validCount = 0;

    selected.forEach(checkbox => {
        const card = checkbox.closest('.comp-card');
        const price = parseFloat(card.dataset.price) || 0;
        const sqft = parseFloat(card.dataset.sqft) || 0;

        if (price > 0 && sqft > 0) {
            totalPrice += price;
            totalSqft += sqft;
            validCount++;
        }
    });

    const avgPrice = validCount > 0 ? Math.round(totalPrice / validCount) : 0;
    const avgSqft = validCount > 0 ? Math.round(totalSqft / validCount) : 0;
    const avgPpsf = totalSqft > 0 ? Math.round(totalPrice / totalSqft) : 0;

    document.getElementById('calc-count').textContent = selected.length;
    document.getElementById('calc-ppsf').textContent = '$' + avgPpsf.toLocaleString();
    document.getElementById('calc-price').textContent = '$' + avgPrice.toLocaleString();
    document.getElementById('calc-size').textContent = avgSqft.toLocaleString() + ' sf';

    // Update profit analysis with selected comp data
    updateProfitAnalysis({
        avgPrice: avgPrice,
        avgSqft: avgSqft,
        avgPpsf: avgPpsf,
        count: validCount
    });
}

function updateCompMarkerColors() {
    const selectedIds = new Set();
    document.querySelectorAll('.comp-card input.comp-select:checked').forEach(checkbox => {
        const card = checkbox.closest('.comp-card');
        selectedIds.add(card.dataset.id);
    });

    // Update each marker's icon based on selection
    compMarkers.forEach(marker => {
        const isSelected = selectedIds.has(marker.compId);
        const iconClass = isSelected ? 'marker-comp-selected' : 'marker-comp';
        const iconSize = isSelected ? [14, 14] : [12, 12];
        const iconAnchor = isSelected ? [7, 7] : [6, 6];

        const newIcon = L.divIcon({
            className: iconClass,
            iconSize: iconSize,
            iconAnchor: iconAnchor
        });
        marker.setIcon(newIcon);
    });
}

function updateProfitAnalysis(compData) {
    const profitSection = document.getElementById('profit-analysis');
    if (!profitSection) return;

    // Store for recalc when input changes
    if (compData) lastCompData = compData;

    if (!lastCompData || !currentProperty) {
        profitSection.innerHTML = `
            <div class="profit-placeholder">
                Select comps to calculate
            </div>
        `;
        return;
    }

    const data = lastCompData;
    const askingPrice = currentProperty.unformattedPrice || 0;
    const interestRate = 0.08;
    const holdingMonths = 18;
    const interestFactor = interestRate * (holdingMonths / 12); // 0.12
    const mgmtFeeRate = 0.12;

    // From comps
    const targetSalePrice = data.avgPrice;
    const avgBuildSize = data.avgSqft;

    // Interest on asking price
    const interestOnAsking = Math.round(askingPrice * interestFactor);

    // Operating margin at asking price
    const opMarginAtAsking = targetSalePrice - askingPrice - interestOnAsking;
    const mgmtFeeAtAsking = Math.round(opMarginAtAsking * mgmtFeeRate);
    const buildMarginAtAsking = opMarginAtAsking - mgmtFeeAtAsking;
    const targetBuildPpsf = avgBuildSize > 0 ? Math.round(buildMarginAtAsking / avgBuildSize) : 0;

    // Realistic build cost calculation
    const totalBuildCost = realisticBuildCost * avgBuildSize;

    // Viable purchase price calculation
    // Formula: P = (TargetSale - BuildCost) √ó 0.893 (accounts for interest + mgmt fee)
    const viableFactor = 0.88 / 0.9856; // ~0.893
    const viablePurchasePrice = Math.round((targetSalePrice - totalBuildCost) * viableFactor);

    // Verify with actual costs at viable price
    const interestAtViable = Math.round(viablePurchasePrice * interestFactor);
    const opMarginAtViable = targetSalePrice - viablePurchasePrice - interestAtViable - totalBuildCost;
    const mgmtFeeAtViable = Math.round(opMarginAtViable * mgmtFeeRate);
    const netProfitAtViable = opMarginAtViable - mgmtFeeAtViable;

    // Is deal viable at asking?
    const dealViable = askingPrice <= viablePurchasePrice;
    const priceDiff = viablePurchasePrice - askingPrice;

    const marginClass = buildMarginAtAsking > 500000 ? 'profit-high' :
                        buildMarginAtAsking > 200000 ? 'profit-medium' : 'profit-low';

    profitSection.innerHTML = `
        <div class="profit-breakdown">
            <div class="profit-section-header">Market Data (${data.count} comps)</div>
            <div class="profit-row">
                <span class="profit-label">Target Sale Price</span>
                <span class="profit-value">$${targetSalePrice.toLocaleString()}</span>
            </div>
            <div class="profit-row">
                <span class="profit-label">Avg Build Size</span>
                <span class="profit-value">${avgBuildSize.toLocaleString()} sf</span>
            </div>
            <div class="profit-row">
                <span class="profit-label">Market $/sf</span>
                <span class="profit-value">$${data.avgPpsf.toLocaleString()}</span>
            </div>

            <div class="profit-divider"></div>
            <div class="profit-section-header">At Asking Price</div>
            <div class="profit-row">
                <span class="profit-label">Purchase (asking)</span>
                <span class="profit-value">$${askingPrice.toLocaleString()}</span>
            </div>
            <div class="profit-row">
                <span class="profit-label">+ Interest (8%√ó18mo)</span>
                <span class="profit-value">$${interestOnAsking.toLocaleString()}</span>
            </div>
            <div class="profit-row subtotal">
                <span class="profit-label">Operating Margin</span>
                <span class="profit-value ${opMarginAtAsking > 0 ? 'positive' : 'negative'}">$${opMarginAtAsking.toLocaleString()}</span>
            </div>
            <div class="profit-row">
                <span class="profit-label">‚àí Mgmt Fee (12%)</span>
                <span class="profit-value">$${mgmtFeeAtAsking.toLocaleString()}</span>
            </div>
            <div class="profit-row total">
                <span class="profit-label">Build Margin</span>
                <span class="profit-value ${marginClass}">$${buildMarginAtAsking.toLocaleString()}</span>
            </div>
            <div class="profit-row total">
                <span class="profit-label">Target Build $/sf</span>
                <span class="profit-value ${marginClass}">$${targetBuildPpsf.toLocaleString()}</span>
            </div>

            <div class="profit-divider"></div>
            <div class="profit-section-header">Viability Analysis</div>
            <div class="profit-row input-row">
                <span class="profit-label">Realistic Build $/sf</span>
                <span class="profit-value">
                    $<input type="number" class="build-cost-input" value="${realisticBuildCost}"
                           onchange="updateBuildCost(this.value)" onclick="event.stopPropagation()">
                </span>
            </div>
            <div class="profit-row">
                <span class="profit-label">Total Build Cost</span>
                <span class="profit-value">$${totalBuildCost.toLocaleString()}</span>
            </div>
            <div class="profit-row result-row">
                <span class="profit-label">Max Viable Purchase</span>
                <span class="profit-value ${dealViable ? 'positive' : 'negative'}">$${viablePurchasePrice.toLocaleString()}</span>
            </div>
            <div class="profit-row">
                <span class="profit-label">${dealViable ? 'Under asking by' : 'Over asking by'}</span>
                <span class="profit-value ${dealViable ? 'positive' : 'negative'}">${dealViable ? '+' : ''}$${Math.abs(priceDiff).toLocaleString()}</span>
            </div>
        </div>
    `;
}

function updateBuildCost(value) {
    realisticBuildCost = parseInt(value) || 400;
    updateProfitAnalysis(null); // Recalc with stored data
}

// Resizable columns
function initResizeHandles() {
    const rightPanel = document.getElementById('analyze-right');
    const resizeRight = document.getElementById('resize-right');

    let isResizing = false;

    function startResize(e) {
        isResizing = true;
        resizeRight.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
    }

    function stopResize() {
        isResizing = false;
        resizeRight.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
    }

    function resize(e) {
        if (!isResizing) return;
        const containerRight = rightPanel.parentElement.getBoundingClientRect().right;
        const newWidth = containerRight - e.clientX;
        if (newWidth >= 180 && newWidth <= 500) {
            rightPanel.style.width = newWidth + 'px';
        }
    }

    resizeRight.addEventListener('mousedown', startResize);
    document.addEventListener('mousemove', resize);
    document.addEventListener('mouseup', stopResize);
}

document.addEventListener('DOMContentLoaded', () => {
    loadSelected();
    loadAnalyzePage();
    initResizeHandles();
});
</script>
{% endblock %}
